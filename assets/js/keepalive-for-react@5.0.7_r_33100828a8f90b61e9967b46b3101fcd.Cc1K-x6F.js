import{r as e,j as t}from"./react@19.2.3.D3o_8b5j.js";import{r}from"./react-dom@19.2.3_react@19.2.3.CIkYuaQ_.js";function n(e){return null==e}function i(e){return"[object RegExp]"===Object.prototype.toString.call(e)}function c(e){return Array.isArray(e)}function a(e){return"function"==typeof e}function s(e){return{set:(t,r)=>(e.setAttribute(t,r),s(e))}}function o(e=100){let t;return new Promise((r,i)=>{t=setTimeout(()=>{r(),n(t)||clearTimeout(t)},e)})}function l(e,t){return(c(e)?e:n(e)?[]:[e]).some(e=>i(e)?e.test(t):t===e)}function u(e){setTimeout(e,0)}var d=e.createContext({active:!1,refresh:()=>{},destroy:()=>Promise.resolve(),destroyAll:()=>Promise.resolve(),destroyOther:()=>Promise.resolve(),getCacheNodes:()=>[]}),f=e.memo(function(r){let{children:n,active:i,refresh:c,destroy:a,destroyAll:s,destroyOther:o,getCacheNodes:l}=r,u=e.useMemo(()=>({active:i,refresh:c,destroy:a,destroyAll:s,destroyOther:o,getCacheNodes:l}),[i,c,a,s,o,l]);return t.jsx(d.Provider,{value:u,children:n})}),m=e.Activity,h=null!=m?m:e.Fragment,v=!!m,y="keepalive-cache-div";function C(e){return e?Array.from(e.children):[]}function A(e){e.forEach(e=>{e.classList.contains(y)&&e.remove()})}function x(e,t){A(C(e)),e.appendChild(t),t.classList.remove("inactive"),t.classList.add("active")}function p(e,t){let r=C(e).filter(e=>e.classList.contains("active")&&e.getAttribute("data-cache-key")!==t);return r.forEach(e=>{e.classList.remove("active"),e.classList.add("inactive")}),r}var T=e.memo(function(n){let{errorElement:i=e.Fragment,cacheNodeClassName:c,children:a,cacheKey:u,exclude:d,include:f,enableActivity:m}=n,{active:C,renderCount:T,destroy:g,transition:N,viewTransition:b,duration:j,containerDivRef:w}=n,k=e.useRef(!1);k.current=k.current||C;let E=e.useMemo(()=>{let e=document.createElement("div");return s(e).set("data-cache-key",u).set("style","height: 100%").set("data-render-count",T.toString()),e.className=y+(c?" ".concat(c):""),e},[T,c]);return e.useEffect(()=>{let e=function(e,t,r){return r?l(r,e):!t||!l(t,e)}(u,d,f),t=w.current;if(t)if(N)(async()=>{if(C){let e=p(t,u);if(await o(j-40),A(e),t.contains(E))return;x(t,E)}else e||(await o(j),g(u))})();else if(C){let e=()=>{A(p(t,u)),!t.contains(E)&&x(t,E)};b&&document.startViewTransition?document.startViewTransition(e):e()}else e||g(u)},[C,w,u,d,f]),k.current?r.createPortal(t.jsx(i,{children:v&&m?t.jsxs(h,{mode:C?"visible":"hidden",children:[" ",a]}):a}),E,u):null},(e,t)=>e.active===t.active&&e.renderCount===t.renderCount&&e.children===t.children&&e.exclude===t.exclude&&e.include===t.include),g=t=>{typeof e.startTransition<"u"&&a(e.startTransition)?e.startTransition(t):t()};function N(){return e.useRef(null)}var b=function(r){let{activeCacheKey:s,max:o=10,exclude:l,include:d,onBeforeActive:m,customContainerRef:h,cacheNodeClassName:v="cache-component",containerClassName:y="keep-alive-render",errorElement:C,transition:A=!1,viewTransition:x=!1,duration:p=200,children:N,aliveRef:b,maxAliveTime:j=0,enableActivity:w=!1}=r,k=h||e.useRef(null),[E,K]=e.useState([]);e.useLayoutEffect(()=>{n(s)||g(()=>{K(e=>{let t=Date.now();if(e.find(e=>e.cacheKey===s))return e.map(e=>{if(e.cacheKey===s){let r=!1;if(a(m)&&m(s),j){let n=e.lastActiveTime;if(c(j)){let e=j.find(e=>i(e.match)?e.match.test(s):e.match===s);e&&(r=e&&n+1e3*e.expire<t)}else r=n+1e3*j<t}return{...e,ele:N,lastActiveTime:t,renderCount:r?e.renderCount+1:e.renderCount}}return e});if(a(m)&&m(s),e.length>o){let t=e.reduce((e,t)=>e.lastActiveTime<t.lastActiveTime?e:t);e.splice(e.indexOf(t),1)}return[...e,{cacheKey:s,lastActiveTime:t,ele:N,renderCount:0}]})})},[s,N]);let P=e.useCallback(e=>{K(t=>{let r=e||s;return t.map(e=>e.cacheKey===r?{...e,renderCount:e.renderCount+1}:e)})},[K,s]),R=e.useCallback(e=>{let t=e||s,r=c(t)?t:[t];return new Promise(e=>{u(()=>{K(e=>[...e.filter(e=>!r.includes(e.cacheKey))]),e()})})},[K,s]),L=e.useCallback(()=>new Promise(e=>{u(()=>{K([]),e()})}),[K]),O=e.useCallback(e=>{let t=e||s;return new Promise(e=>{u(()=>{K(e=>[...e.filter(e=>e.cacheKey===t)]),e()})})},[s,K]),D=e.useCallback(()=>E,[E]);return e.useImperativeHandle(b,()=>({refresh:P,destroy:R,destroyAll:L,destroyOther:O,getCacheNodes:D})),t.jsxs(e.Fragment,{children:[t.jsx("div",{ref:k,className:y,style:{height:"100%"}}),E.map(e=>{let{cacheKey:r,ele:n,renderCount:i}=e;return t.jsx(f,{active:s===r,refresh:P,destroy:R,destroyAll:L,destroyOther:O,getCacheNodes:D,children:t.jsx(T,{destroy:R,include:d,exclude:l,transition:A,viewTransition:x,duration:p,renderCount:i,containerDivRef:k,errorElement:C,active:s===r,cacheNodeClassName:v,cacheKey:r,enableActivity:w,children:n})},"".concat(r,"-").concat(i))})]})},j=()=>e.useContext(d);var w=function(t,r,n=!1,i){let{active:c}=j(),s=e.useRef(!1);i(()=>{if(!c)return;if(n&&!s.current)return void(s.current=!0);let e=t();return()=>{a(e)&&e()}},[c,...r])},k=(t,r,n=!1)=>{w(t,r,n,e.useEffect)};export{k as H,b as L,N as c};
